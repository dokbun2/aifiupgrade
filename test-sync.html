<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>동기화 시스템 테스트</title>
    <style>
        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            padding: 10px 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .status {
            padding: 10px;
            background: #f5f5f5;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
        }
        .data-display {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .item {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        .success {
            color: #4caf50;
            font-weight: bold;
        }
        .error {
            color: #f44336;
            font-weight: bold;
        }
        .info {
            color: #2196f3;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ConceptArtManager 테스트 패널 -->
        <div class="panel">
            <h2>📦 ConceptArtManager (데이터 추가)</h2>

            <div class="controls">
                <h3>캐릭터 추가</h3>
                <input type="text" id="charName" placeholder="캐릭터 이름">
                <input type="text" id="charDesc" placeholder="캐릭터 설명">
                <button onclick="addCharacter()">캐릭터 추가</button>

                <h3>장소 추가</h3>
                <input type="text" id="locName" placeholder="장소 이름">
                <input type="text" id="locDesc" placeholder="장소 설명">
                <button onclick="addLocation()">장소 추가</button>

                <h3>소품 추가</h3>
                <input type="text" id="propName" placeholder="소품 이름">
                <input type="text" id="propDesc" placeholder="소품 설명">
                <button onclick="addProp()">소품 추가</button>
            </div>

            <button onclick="refreshManagerData()">데이터 새로고침</button>
            <button onclick="clearAllData()">모든 데이터 삭제</button>

            <h3>현재 데이터</h3>
            <div id="managerData" class="data-display"></div>

            <h3>상태 로그</h3>
            <div id="managerStatus" class="status"></div>
        </div>

        <!-- ShotDetailDataSync 테스트 패널 -->
        <div class="panel">
            <h2>🔄 ShotDetailDataSync (동기화 확인)</h2>

            <div class="controls">
                <h3>캐릭터 셀렉터</h3>
                <select id="characterSelector">
                    <option value="">캐릭터 선택</option>
                </select>

                <h3>장소 셀렉터</h3>
                <select id="locationSelector">
                    <option value="">장소 선택</option>
                </select>

                <h3>소품 셀렉터</h3>
                <select id="propsSelector">
                    <option value="">소품 선택</option>
                </select>
            </div>

            <button onclick="requestSync()">동기화 요청</button>
            <button onclick="checkSelectors()">셀렉터 상태 확인</button>

            <h3>동기화된 데이터</h3>
            <div id="syncData" class="data-display"></div>

            <h3>상태 로그</h3>
            <div id="syncStatus" class="status"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/concept-art-manager.js"></script>
    <script src="js/shot-detail-sync.js"></script>
    <script>
        // 로그 출력 함수
        function log(target, message, type = 'info') {
            const statusEl = document.getElementById(target);
            const time = new Date().toLocaleTimeString();
            const msgEl = document.createElement('div');
            msgEl.className = type;
            msgEl.innerHTML = `[${time}] ${message}`;
            statusEl.appendChild(msgEl);
            statusEl.scrollTop = statusEl.scrollHeight;
        }

        // ConceptArtManager 테스트 함수들
        function addCharacter() {
            const name = document.getElementById('charName').value;
            const description = document.getElementById('charDesc').value;

            if (!name) {
                log('managerStatus', '캐릭터 이름을 입력하세요.', 'error');
                return;
            }

            const char = window.conceptArtManager.addCharacter({
                name: name,
                description: description
            });

            log('managerStatus', `캐릭터 추가됨: ${char.name} (ID: ${char.id})`, 'success');
            document.getElementById('charName').value = '';
            document.getElementById('charDesc').value = '';
            refreshManagerData();
        }

        function addLocation() {
            const name = document.getElementById('locName').value;
            const description = document.getElementById('locDesc').value;

            if (!name) {
                log('managerStatus', '장소 이름을 입력하세요.', 'error');
                return;
            }

            const loc = window.conceptArtManager.addLocation({
                name: name,
                description: description
            });

            log('managerStatus', `장소 추가됨: ${loc.name} (ID: ${loc.id})`, 'success');
            document.getElementById('locName').value = '';
            document.getElementById('locDesc').value = '';
            refreshManagerData();
        }

        function addProp() {
            const name = document.getElementById('propName').value;
            const description = document.getElementById('propDesc').value;

            if (!name) {
                log('managerStatus', '소품 이름을 입력하세요.', 'error');
                return;
            }

            const prop = window.conceptArtManager.addProp({
                name: name,
                description: description
            });

            log('managerStatus', `소품 추가됨: ${prop.name} (ID: ${prop.id})`, 'success');
            document.getElementById('propName').value = '';
            document.getElementById('propDesc').value = '';
            refreshManagerData();
        }

        function refreshManagerData() {
            const data = window.conceptArtManager.getData();
            const display = document.getElementById('managerData');

            if (!data) {
                display.innerHTML = '<div class="item">데이터 없음</div>';
                return;
            }

            let html = '';

            // 캐릭터
            html += `<strong>캐릭터 (${data.characters?.length || 0})</strong>`;
            if (data.characters?.length) {
                data.characters.forEach(c => {
                    html += `<div class="item">📦 ${c.name} (${c.source})</div>`;
                });
            }

            // 장소
            html += `<strong>장소 (${data.locations?.length || 0})</strong>`;
            if (data.locations?.length) {
                data.locations.forEach(l => {
                    html += `<div class="item">🏛️ ${l.name} (${l.source})</div>`;
                });
            }

            // 소품
            html += `<strong>소품 (${data.props?.length || 0})</strong>`;
            if (data.props?.length) {
                data.props.forEach(p => {
                    html += `<div class="item">🎭 ${p.name} (${p.source})</div>`;
                });
            }

            display.innerHTML = html;
            log('managerStatus', '데이터 새로고침 완료', 'success');
        }

        function clearAllData() {
            if (confirm('정말 모든 데이터를 삭제하시겠습니까?')) {
                window.conceptArtManager.clearAllData();
                log('managerStatus', '모든 데이터 삭제됨', 'success');
                refreshManagerData();
                checkSelectors();
            }
        }

        // ShotDetailDataSync 테스트 함수들
        function requestSync() {
            window.shotDetailSync.requestSync();
            log('syncStatus', '동기화 요청 전송됨', 'info');
            setTimeout(checkSelectors, 100);
        }

        function checkSelectors() {
            const charSel = document.getElementById('characterSelector');
            const locSel = document.getElementById('locationSelector');
            const propSel = document.getElementById('propsSelector');

            log('syncStatus', `캐릭터 옵션: ${charSel.options.length - 1}개`, 'info');
            log('syncStatus', `장소 옵션: ${locSel.options.length - 1}개`, 'info');
            log('syncStatus', `소품 옵션: ${propSel.options.length - 1}개`, 'info');

            // 동기화된 데이터 표시
            const syncData = document.getElementById('syncData');
            let html = '';

            html += '<strong>캐릭터 셀렉터</strong>';
            for (let i = 1; i < charSel.options.length; i++) {
                html += `<div class="item">👤 ${charSel.options[i].text}</div>`;
            }

            html += '<strong>장소 셀렉터</strong>';
            for (let i = 1; i < locSel.options.length; i++) {
                html += `<div class="item">📍 ${locSel.options[i].text}</div>`;
            }

            html += '<strong>소품 셀렉터</strong>';
            for (let i = 1; i < propSel.options.length; i++) {
                html += `<div class="item">📦 ${propSel.options[i].text}</div>`;
            }

            syncData.innerHTML = html || '<div class="item">동기화된 데이터 없음</div>';
        }

        // 페이지 로드 시 초기화
        window.addEventListener('DOMContentLoaded', () => {
            log('managerStatus', 'ConceptArtManager 초기화됨', 'success');
            log('syncStatus', 'ShotDetailDataSync 초기화됨', 'success');

            // 초기 데이터 로드
            refreshManagerData();
            setTimeout(checkSelectors, 500);

            // BroadcastChannel 상태 확인
            if (window.BroadcastChannel) {
                log('syncStatus', 'BroadcastChannel 지원됨 ✅', 'success');
            } else {
                log('syncStatus', 'BroadcastChannel 미지원 - Storage 이벤트 사용', 'info');
            }
        });
    </script>
</body>
</html>