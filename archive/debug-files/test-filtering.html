<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>필터링 테스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            border: 2px solid #333;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .info {
            color: blue;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>스테이지 1 & 2 JSON 필터링 테스트</h1>

    <div class="section">
        <h2>1. JSON 파일 로드</h2>
        <button onclick="loadJSONFiles()">JSON 파일 로드</button>
        <div id="loadResult"></div>
    </div>

    <div class="section">
        <h2>2. 필터링 테스트</h2>
        <button onclick="testFiltering('S01.02.01')">S01.02.01 씬 테스트</button>
        <button onclick="testFiltering('S03.02.01')">S03.02.01 씬 테스트</button>
        <div id="filterResult"></div>
    </div>

    <script>
        let stage1Data = null;
        let stage2Data = null;

        async function loadJSONFiles() {
            const resultDiv = document.getElementById('loadResult');
            resultDiv.innerHTML = '<p class="info">JSON 파일 로딩 중...</p>';

            try {
                // Stage1 JSON 로드
                const stage1Response = await fetch('/Users/sohee/Downloads/run/[아이파이강의]/아이파이/업그레이드/샘플제이슨/귀면의칼날 샘플1.json');
                if (!stage1Response.ok) {
                    // 상대경로로 시도
                    const stage1Response2 = await fetch('../[아이파이강의]/아이파이/업그레이드/샘플제이슨/귀면의칼날 샘플1.json');
                    stage1Data = await stage1Response2.json();
                } else {
                    stage1Data = await stage1Response.json();
                }

                // Stage2 JSON 로드
                const stage2Response = await fetch('/Users/sohee/Downloads/run/[아이파이강의]/아이파이/업그레이드/샘플제이슨/귀멸의칼날샘플2.json');
                if (!stage2Response.ok) {
                    // 상대경로로 시도
                    const stage2Response2 = await fetch('../[아이파이강의]/아이파이/업그레이드/샘플제이슨/귀멸의칼날샘플2.json');
                    stage2Data = await stage2Response2.json();
                } else {
                    stage2Data = await stage2Response.json();
                }

                resultDiv.innerHTML = `
                    <p class="success">✅ JSON 파일 로드 성공!</p>
                    <h3>Stage1 데이터:</h3>
                    <p>캐릭터: ${stage1Data.visual_blocks?.characters?.map(c => c.name).join(', ') || '없음'}</p>
                    <p>장소: ${stage1Data.visual_blocks?.locations?.map(l => l.name).join(', ') || '없음'}</p>

                    <h3>Stage2 데이터:</h3>
                    <p>씬 개수: ${stage2Data.scenes?.length || 0}</p>
                `;

                // 각 씬의 concept_art_references 확인
                if (stage2Data.scenes) {
                    stage2Data.scenes.forEach(scene => {
                        console.log(`Scene ${scene.scene_id} concept_art_references:`, scene.concept_art_references);
                    });
                }

            } catch (error) {
                resultDiv.innerHTML = `<p class="error">❌ 에러: ${error.message}</p>`;
                console.error('JSON 로드 에러:', error);
            }
        }

        function testFiltering(shotId) {
            const resultDiv = document.getElementById('filterResult');

            if (!stage1Data || !stage2Data) {
                resultDiv.innerHTML = '<p class="error">먼저 JSON 파일을 로드해주세요!</p>';
                return;
            }

            resultDiv.innerHTML = `<h3>${shotId} 필터링 테스트</h3>`;

            // Stage2에서 해당 샷 찾기
            let targetShot = null;
            let targetScene = null;

            for (const scene of stage2Data.scenes) {
                if (scene.shots) {
                    const shot = scene.shots.find(s => s.shot_id === shotId);
                    if (shot) {
                        targetShot = shot;
                        targetScene = scene;
                        break;
                    }
                }
            }

            if (!targetShot) {
                resultDiv.innerHTML += `<p class="error">❌ 샷 ${shotId}를 찾을 수 없습니다.</p>`;
                return;
            }

            // concept_art_references 가져오기
            const conceptArtRefs = targetShot.concept_art_references || targetScene.concept_art_references;

            resultDiv.innerHTML += `
                <h4>Stage2 concept_art_references:</h4>
                <pre>${JSON.stringify(conceptArtRefs, null, 2)}</pre>
            `;

            // 캐릭터 필터링 테스트
            if (conceptArtRefs?.characters && stage1Data.visual_blocks?.characters) {
                const allCharacters = stage1Data.visual_blocks.characters;
                const sceneCharacters = conceptArtRefs.characters;

                resultDiv.innerHTML += '<h4>캐릭터 필터링:</h4>';
                resultDiv.innerHTML += `<p>Stage2 캐릭터: ${sceneCharacters.join(', ')}</p>`;

                const filteredCharacters = allCharacters.filter(char => {
                    return sceneCharacters.some(scenChar =>
                        char.name?.toLowerCase() === scenChar.toLowerCase() ||
                        char.id?.toLowerCase() === scenChar.toLowerCase()
                    );
                });

                resultDiv.innerHTML += `<p class="success">✅ 필터링된 캐릭터: ${filteredCharacters.map(c => c.name).join(', ')}</p>`;

                // 매칭 상세 정보
                allCharacters.forEach(char => {
                    const matched = sceneCharacters.some(scenChar =>
                        char.name?.toLowerCase() === scenChar.toLowerCase()
                    );
                    resultDiv.innerHTML += `<p class="${matched ? 'success' : 'info'}">
                        ${char.name}: ${matched ? '✅ 매칭됨' : '❌ 매칭 안됨'}
                    </p>`;
                });
            }

            // 장소 필터링 테스트
            if (conceptArtRefs?.location && stage1Data.visual_blocks?.locations) {
                const allLocations = stage1Data.visual_blocks.locations;
                const sceneLocation = conceptArtRefs.location;

                resultDiv.innerHTML += '<h4>장소 필터링:</h4>';
                resultDiv.innerHTML += `<p>Stage2 장소: ${sceneLocation}</p>`;

                const matchedLocation = allLocations.find(loc =>
                    loc.name === sceneLocation || loc.id === sceneLocation
                );

                if (matchedLocation) {
                    resultDiv.innerHTML += `<p class="success">✅ 매칭된 장소: ${matchedLocation.name}</p>`;
                } else {
                    resultDiv.innerHTML += `<p class="error">❌ 장소 매칭 실패</p>`;
                    resultDiv.innerHTML += `<p>사용 가능한 장소: ${allLocations.map(l => l.name).join(', ')}</p>`;
                }
            }
        }

        // 페이지 로드 시 자동으로 JSON 로드
        window.addEventListener('DOMContentLoaded', loadJSONFiles);
    </script>
</body>
</html>