<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡¬í”„íŠ¸ ì €ì¥ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5a6fd8;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        .info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }
        .data-display {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .prompt-box {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            min-height: 100px;
        }
        .highlight {
            background: yellow;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ” í”„ë¡¬í”„íŠ¸ ì €ì¥ í…ŒìŠ¤íŠ¸</h1>

    <div class="test-section">
        <h2>1. í˜„ì¬ ì €ì¥ëœ ë°ì´í„° í™•ì¸</h2>
        <button onclick="checkCurrentData()">localStorage ë°ì´í„° í™•ì¸</button>
        <button onclick="clearLocalStorage()">localStorage ì´ˆê¸°í™”</button>
        <div id="currentDataStatus"></div>
        <div id="currentDataDisplay" class="data-display"></div>
    </div>

    <div class="test-section">
        <h2>2. í”„ë¡¬í”„íŠ¸ ë°ì´í„° ë¶„ì„</h2>
        <button onclick="analyzePromptData()">í”„ë¡¬í”„íŠ¸ ë°ì´í„° ë¶„ì„</button>
        <div id="promptAnalysis"></div>

        <h3>Universal í”„ë¡¬í”„íŠ¸:</h3>
        <div id="universalPrompt" class="prompt-box">-</div>

        <h3>Universal ë²ˆì—­:</h3>
        <div id="universalTranslated" class="prompt-box">-</div>

        <h3>Voice Style:</h3>
        <div id="voiceStyle" class="prompt-box">-</div>
    </div>

    <div class="test-section">
        <h2>3. í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤</h2>
        <button onclick="simulateSavePrompt()">í”„ë¡¬í”„íŠ¸ ì €ì¥ ì‹œë®¬ë ˆì´ì…˜</button>
        <button onclick="simulateReload()">í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œë®¬ë ˆì´ì…˜</button>
        <button onclick="compareBeforeAfter()">ì €ì¥ ì „í›„ ë¹„êµ</button>
        <div id="testResult"></div>
    </div>

    <div class="test-section">
        <h2>4. ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h2>
        <button onclick="startMonitoring()">ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
        <button onclick="stopMonitoring()">ëª¨ë‹ˆí„°ë§ ì¤‘ì§€</button>
        <div id="monitorStatus"></div>
        <div id="monitorLog" class="data-display"></div>
    </div>

    <script>
        let monitorInterval = null;
        let originalData = null;

        // localStorage ë°ì´í„° í™•ì¸
        function checkCurrentData() {
            const data = localStorage.getItem('conceptArtData');
            const status = document.getElementById('currentDataStatus');
            const display = document.getElementById('currentDataDisplay');

            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    status.innerHTML = `<div class="status success">âœ… ë°ì´í„° ë°œê²¬ (í¬ê¸°: ${data.length} bytes)</div>`;

                    // ë°ì´í„° ìš”ì•½
                    const summary = {
                        universal: parsed.universal ? `ìˆìŒ (${parsed.universal.length}ì)` : 'ì—†ìŒ',
                        universal_translated: parsed.universal_translated ? `ìˆìŒ (${parsed.universal_translated.length}ì)` : 'ì—†ìŒ',
                        voice_style: parsed.voice_style ? 'ìˆìŒ' : 'ì—†ìŒ',
                        prompts: parsed.prompts ? Object.keys(parsed.prompts).length + 'ê°œ' : '0ê°œ',
                        characters: parsed.characters?.length || 0,
                        locations: parsed.locations?.length || 0,
                        props: parsed.props?.length || 0,
                        images: parsed.images ? Object.keys(parsed.images).length + 'ê°œ' : '0ê°œ'
                    };

                    display.innerHTML = `<pre>${JSON.stringify(summary, null, 2)}</pre>`;
                } catch (e) {
                    status.innerHTML = `<div class="status error">âŒ íŒŒì‹± ì˜¤ë¥˜: ${e.message}</div>`;
                    display.innerHTML = '';
                }
            } else {
                status.innerHTML = `<div class="status info">â„¹ï¸ ì €ì¥ëœ ë°ì´í„° ì—†ìŒ</div>`;
                display.innerHTML = '';
            }
        }

        // í”„ë¡¬í”„íŠ¸ ë°ì´í„° ë¶„ì„
        function analyzePromptData() {
            const data = localStorage.getItem('conceptArtData');
            const analysis = document.getElementById('promptAnalysis');

            if (data) {
                try {
                    const parsed = JSON.parse(data);

                    // Universal prompts í‘œì‹œ
                    document.getElementById('universalPrompt').innerHTML =
                        parsed.universal ? parsed.universal.replace(/\n/g, '<br>') : '<span style="color: #999;">ì—†ìŒ</span>';

                    document.getElementById('universalTranslated').innerHTML =
                        parsed.universal_translated ? parsed.universal_translated.replace(/\n/g, '<br>') : '<span style="color: #999;">ì—†ìŒ</span>';

                    document.getElementById('voiceStyle').innerHTML =
                        parsed.voice_style ? parsed.voice_style.replace(/\n/g, '<br>') : '<span style="color: #999;">ì—†ìŒ</span>';

                    // í”„ë¡¬í”„íŠ¸ ë¶„ì„
                    let promptCount = 0;
                    let promptsWithUniversal = 0;
                    let promptsWithTranslated = 0;
                    let promptsWithVoice = 0;

                    if (parsed.prompts) {
                        for (const [key, value] of Object.entries(parsed.prompts)) {
                            promptCount++;
                            if (value.universal) promptsWithUniversal++;
                            if (value.universal_translated) promptsWithTranslated++;
                            if (value.voice_style) promptsWithVoice++;
                        }
                    }

                    analysis.innerHTML = `
                        <div class="status info">
                            ğŸ“Š í”„ë¡¬í”„íŠ¸ ë¶„ì„ ê²°ê³¼:
                            <ul>
                                <li>ì „ì²´ í”„ë¡¬í”„íŠ¸: ${promptCount}ê°œ</li>
                                <li>Universal í”„ë¡¬í”„íŠ¸ ìˆëŠ” í•­ëª©: ${promptsWithUniversal}ê°œ</li>
                                <li>ë²ˆì—­ëœ í”„ë¡¬í”„íŠ¸ ìˆëŠ” í•­ëª©: ${promptsWithTranslated}ê°œ</li>
                                <li>Voice style ìˆëŠ” í•­ëª©: ${promptsWithVoice}ê°œ</li>
                                <li>í˜„ì¬ ì„ íƒ: ${parsed.currentType || 'ì—†ìŒ'}</li>
                                <li>í˜„ì¬ ìºë¦­í„°: ${parsed.currentCharacter || 'ì—†ìŒ'}</li>
                                <li>í˜„ì¬ ì¥ì†Œ: ${parsed.currentLocation || 'ì—†ìŒ'}</li>
                                <li>í˜„ì¬ ì†Œí’ˆ: ${parsed.currentProps || 'ì—†ìŒ'}</li>
                            </ul>
                        </div>
                    `;
                } catch (e) {
                    analysis.innerHTML = `<div class="status error">âŒ ë¶„ì„ ì˜¤ë¥˜: ${e.message}</div>`;
                }
            } else {
                analysis.innerHTML = `<div class="status info">â„¹ï¸ ë¶„ì„í•  ë°ì´í„° ì—†ìŒ</div>`;
            }
        }

        // í”„ë¡¬í”„íŠ¸ ì €ì¥ ì‹œë®¬ë ˆì´ì…˜
        function simulateSavePrompt() {
            const testPrompt = `í…ŒìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ ${Date.now()}
ì¤„ë°”ê¿ˆ í…ŒìŠ¤íŠ¸
íŠ¹ìˆ˜ë¬¸ì í…ŒìŠ¤íŠ¸: !@#$%^&*()`;

            const data = localStorage.getItem('conceptArtData');
            if (data) {
                try {
                    const parsed = JSON.parse(data);

                    // ì›ë³¸ ì €ì¥
                    originalData = JSON.parse(JSON.stringify(parsed));

                    // í”„ë¡¬í”„íŠ¸ ìˆ˜ì •
                    parsed.universal = testPrompt;
                    parsed.universal_translated = `ë²ˆì—­ëœ ${testPrompt}`;
                    parsed.voice_style = `ìŒì„± ìŠ¤íƒ€ì¼ ${Date.now()}`;

                    // ì €ì¥
                    localStorage.setItem('conceptArtData', JSON.stringify(parsed));

                    document.getElementById('testResult').innerHTML = `
                        <div class="status success">
                            âœ… í”„ë¡¬í”„íŠ¸ ì €ì¥ ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ
                            <br>Universal: ${testPrompt.substring(0, 50)}...
                        </div>
                    `;

                    // ë°ì´í„° ë‹¤ì‹œ í™•ì¸
                    analyzePromptData();
                } catch (e) {
                    document.getElementById('testResult').innerHTML = `
                        <div class="status error">âŒ ì‹œë®¬ë ˆì´ì…˜ ì˜¤ë¥˜: ${e.message}</div>
                    `;
                }
            } else {
                // ìƒˆ ë°ì´í„° ìƒì„±
                const newData = {
                    universal: testPrompt,
                    universal_translated: `ë²ˆì—­ëœ ${testPrompt}`,
                    voice_style: `ìŒì„± ìŠ¤íƒ€ì¼ ${Date.now()}`,
                    prompts: {},
                    characters: [],
                    locations: [],
                    props: []
                };

                localStorage.setItem('conceptArtData', JSON.stringify(newData));
                document.getElementById('testResult').innerHTML = `
                    <div class="status success">âœ… ìƒˆ ë°ì´í„° ìƒì„± ë° ì €ì¥ ì™„ë£Œ</div>
                `;

                analyzePromptData();
            }
        }

        // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì‹œë®¬ë ˆì´ì…˜
        function simulateReload() {
            const beforeData = localStorage.getItem('conceptArtData');

            // ì ì‹œ í›„ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
            setTimeout(() => {
                const afterData = localStorage.getItem('conceptArtData');
                const result = document.getElementById('testResult');

                if (beforeData === afterData) {
                    result.innerHTML = `
                        <div class="status success">âœ… ë°ì´í„° ìœ ì§€ë¨ (ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ë™ì¼)</div>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="status error">âŒ ë°ì´í„° ë³€ê²½ë¨!</div>
                    `;
                }

                checkCurrentData();
                analyzePromptData();
            }, 100);
        }

        // ì €ì¥ ì „í›„ ë¹„êµ
        function compareBeforeAfter() {
            const currentData = localStorage.getItem('conceptArtData');
            const result = document.getElementById('testResult');

            if (originalData && currentData) {
                const current = JSON.parse(currentData);

                const comparison = {
                    universal: {
                        before: originalData.universal || 'ì—†ìŒ',
                        after: current.universal || 'ì—†ìŒ',
                        changed: originalData.universal !== current.universal
                    },
                    universal_translated: {
                        before: originalData.universal_translated || 'ì—†ìŒ',
                        after: current.universal_translated || 'ì—†ìŒ',
                        changed: originalData.universal_translated !== current.universal_translated
                    },
                    voice_style: {
                        before: originalData.voice_style || 'ì—†ìŒ',
                        after: current.voice_style || 'ì—†ìŒ',
                        changed: originalData.voice_style !== current.voice_style
                    }
                };

                let html = '<div class="status info"><h4>ë¹„êµ ê²°ê³¼:</h4><ul>';
                for (const [key, value] of Object.entries(comparison)) {
                    const status = value.changed ? '<span class="highlight">ë³€ê²½ë¨</span>' : 'ë™ì¼';
                    html += `<li><strong>${key}:</strong> ${status}</li>`;
                    if (value.changed) {
                        html += `<ul><li>ì´ì „: ${value.before.substring(0, 50)}...</li>`;
                        html += `<li>ì´í›„: ${value.after.substring(0, 50)}...</li></ul>`;
                    }
                }
                html += '</ul></div>';

                result.innerHTML = html;
            } else {
                result.innerHTML = `<div class="status info">â„¹ï¸ ë¹„êµí•  ì›ë³¸ ë°ì´í„° ì—†ìŒ</div>`;
            }
        }

        // localStorage ì´ˆê¸°í™”
        function clearLocalStorage() {
            if (confirm('ì •ë§ localStorageë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('conceptArtData');
                localStorage.removeItem('conceptArtData_backup');
                sessionStorage.removeItem('conceptArtData');

                document.getElementById('currentDataStatus').innerHTML =
                    `<div class="status success">âœ… localStorage ì´ˆê¸°í™” ì™„ë£Œ</div>`;
                document.getElementById('currentDataDisplay').innerHTML = '';

                analyzePromptData();
            }
        }

        // ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
        function startMonitoring() {
            if (monitorInterval) {
                stopMonitoring();
            }

            const log = [];
            let lastData = localStorage.getItem('conceptArtData');

            monitorInterval = setInterval(() => {
                const currentData = localStorage.getItem('conceptArtData');

                if (currentData !== lastData) {
                    const timestamp = new Date().toLocaleTimeString();
                    let changeType = 'ë³€ê²½ë¨';

                    if (!lastData && currentData) changeType = 'ìƒì„±ë¨';
                    else if (lastData && !currentData) changeType = 'ì‚­ì œë¨';

                    log.unshift(`[${timestamp}] ë°ì´í„° ${changeType}`);

                    if (log.length > 20) log.pop();

                    document.getElementById('monitorLog').innerHTML =
                        `<pre>${log.join('\n')}</pre>`;

                    lastData = currentData;

                    // ìë™ìœ¼ë¡œ ë°ì´í„° ë¶„ì„
                    analyzePromptData();
                }
            }, 1000);

            document.getElementById('monitorStatus').innerHTML =
                `<div class="status success">ğŸ”´ ëª¨ë‹ˆí„°ë§ ì¤‘...</div>`;
        }

        function stopMonitoring() {
            if (monitorInterval) {
                clearInterval(monitorInterval);
                monitorInterval = null;
                document.getElementById('monitorStatus').innerHTML =
                    `<div class="status info">âš« ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ë¨</div>`;
            }
        }

        // Storage ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.addEventListener('storage', (e) => {
            if (e.key === 'conceptArtData') {
                console.log('Storage ì´ë²¤íŠ¸ ê°ì§€:', e);
                checkCurrentData();
                analyzePromptData();
            }
        });

        // ì´ˆê¸° ë¡œë“œ
        window.addEventListener('DOMContentLoaded', () => {
            checkCurrentData();
            analyzePromptData();
        });
    </script>
</body>
</html>