<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡¬í”„íŠ¸ ì˜êµ¬ ì €ì¥ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
        }
        button:hover {
            background: #5a6fd8;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        .info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }
        .warning {
            background: #fff3e0;
            color: #ef6c00;
            border-left: 4px solid #ff9800;
        }
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .prompt-display {
            background: white;
            border: 2px solid #667eea;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            min-height: 100px;
            white-space: pre-wrap;
        }
        .highlight {
            background: yellow;
            font-weight: bold;
            padding: 2px 4px;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” í”„ë¡¬í”„íŠ¸ ì˜êµ¬ ì €ì¥ í…ŒìŠ¤íŠ¸</h1>

        <!-- 1. í”„ë¡¬í”„íŠ¸ ì§ì ‘ ì €ì¥ í…ŒìŠ¤íŠ¸ -->
        <div class="test-section">
            <h2>1. í”„ë¡¬í”„íŠ¸ ì§ì ‘ ì €ì¥ í…ŒìŠ¤íŠ¸</h2>
            <textarea id="testPrompt" placeholder="í…ŒìŠ¤íŠ¸í•  í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">STYLE: Photorealistic portrait, Steve McCurry style;
ARTIST: Steve McCurry;
MEDIUM: Photography;
GENRE: Heartwarming Comedy;
CHARACTER: Hajun, Korean male 28 chef;</textarea>
            <br>
            <button onclick="saveTestPrompt()">í”„ë¡¬í”„íŠ¸ ì €ì¥</button>
            <button onclick="loadAndCheck()">ì €ì¥ëœ ë°ì´í„° í™•ì¸</button>
            <button onclick="simulateRefresh()">ìƒˆë¡œê³ ì¹¨ ì‹œë®¬ë ˆì´ì…˜</button>
            <div id="saveStatus"></div>
        </div>

        <!-- 2. localStorage ì‹¤ì‹œê°„ ëª¨ë‹ˆí„° -->
        <div class="test-section">
            <h2>2. localStorage ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°</h2>
            <button onclick="monitorStorage()">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
            <button onclick="stopMonitoring()">ëª¨ë‹ˆí„°ë§ ì¤‘ì§€</button>
            <div id="monitorStatus"></div>
            <div class="prompt-display" id="storageMonitor">ëŒ€ê¸°ì¤‘...</div>
        </div>

        <!-- 3. ë°ì´í„° ë¹„êµ -->
        <div class="test-section">
            <h2>3. ì €ì¥ ì „í›„ ë¹„êµ</h2>
            <button onclick="captureBeforeState()">í˜„ì¬ ìƒíƒœ ìº¡ì²˜</button>
            <button onclick="compareStates()">ë³€ê²½ì‚¬í•­ ë¹„êµ</button>
            <div id="compareResult"></div>
        </div>

        <!-- 4. ë¬¸ì œ ì§„ë‹¨ -->
        <div class="test-section">
            <h2>4. ë¬¸ì œ ì§„ë‹¨</h2>
            <button onclick="diagnoseIssue()">ë¬¸ì œ ì§„ë‹¨ ì‹¤í–‰</button>
            <div id="diagnosisResult"></div>
        </div>
    </div>

    <script>
        let monitorInterval = null;
        let beforeState = null;

        // í…ŒìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ ì €ì¥
        function saveTestPrompt() {
            const prompt = document.getElementById('testPrompt').value;
            const status = document.getElementById('saveStatus');

            // ê¸°ì¡´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë˜ëŠ” ìƒˆë¡œ ìƒì„±
            let conceptData = {};
            const existing = localStorage.getItem('conceptArtData');
            if (existing) {
                try {
                    conceptData = JSON.parse(existing);
                } catch (e) {
                    console.error('ê¸°ì¡´ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                    conceptData = {};
                }
            }

            // í”„ë¡¬í”„íŠ¸ ë°ì´í„° ì„¤ì •
            conceptData.universal = prompt;
            conceptData.universal_translated = 'ë²ˆì—­ëœ ' + prompt.substring(0, 50);
            conceptData.lastSaved = new Date().toISOString();

            // prompts ê°ì²´ê°€ ì—†ìœ¼ë©´ ìƒì„±
            if (!conceptData.prompts) {
                conceptData.prompts = {};
            }

            // localStorageì— ì €ì¥
            try {
                const dataString = JSON.stringify(conceptData);
                localStorage.setItem('conceptArtData', dataString);

                // ì €ì¥ í™•ì¸
                const saved = localStorage.getItem('conceptArtData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed.universal === prompt) {
                        status.innerHTML = `
                            <div class="status success">
                                âœ… ì €ì¥ ì„±ê³µ!
                                <br>ì €ì¥ ì‹œê°„: ${new Date().toLocaleTimeString()}
                                <br>ë°ì´í„° í¬ê¸°: ${dataString.length} bytes
                                <br>Universal í”„ë¡¬í”„íŠ¸: ${parsed.universal ? 'ìˆìŒ' : 'ì—†ìŒ'}
                            </div>
                        `;
                    } else {
                        status.innerHTML = `
                            <div class="status warning">
                                âš ï¸ ì €ì¥ë˜ì—ˆì§€ë§Œ ë°ì´í„° ë¶ˆì¼ì¹˜
                            </div>
                        `;
                    }
                } else {
                    status.innerHTML = `
                        <div class="status error">
                            âŒ localStorageì—ì„œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ
                        </div>
                    `;
                }
            } catch (e) {
                status.innerHTML = `
                    <div class="status error">
                        âŒ ì €ì¥ ì˜¤ë¥˜: ${e.message}
                    </div>
                `;
            }
        }

        // ì €ì¥ëœ ë°ì´í„° í™•ì¸
        function loadAndCheck() {
            const status = document.getElementById('saveStatus');
            const data = localStorage.getItem('conceptArtData');

            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    status.innerHTML = `
                        <div class="status info">
                            ğŸ“¦ ì €ì¥ëœ ë°ì´í„°:
                            <pre>${JSON.stringify({
                                universal: parsed.universal ? parsed.universal.substring(0, 100) + '...' : 'ì—†ìŒ',
                                universal_translated: parsed.universal_translated ? 'ìˆìŒ' : 'ì—†ìŒ',
                                lastSaved: parsed.lastSaved || 'ì•Œ ìˆ˜ ì—†ìŒ',
                                prompts: parsed.prompts ? Object.keys(parsed.prompts).length + 'ê°œ' : '0ê°œ'
                            }, null, 2)}</pre>
                        </div>
                    `;
                } catch (e) {
                    status.innerHTML = `
                        <div class="status error">
                            âŒ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜: ${e.message}
                        </div>
                    `;
                }
            } else {
                status.innerHTML = `
                    <div class="status warning">
                        âš ï¸ ì €ì¥ëœ ë°ì´í„° ì—†ìŒ
                    </div>
                `;
            }
        }

        // ìƒˆë¡œê³ ì¹¨ ì‹œë®¬ë ˆì´ì…˜
        function simulateRefresh() {
            const status = document.getElementById('saveStatus');

            // í˜„ì¬ ë°ì´í„° ì €ì¥
            const beforeRefresh = localStorage.getItem('conceptArtData');

            // ì ì‹œ í›„ ë‹¤ì‹œ í™•ì¸
            setTimeout(() => {
                const afterRefresh = localStorage.getItem('conceptArtData');

                if (beforeRefresh === afterRefresh) {
                    status.innerHTML = `
                        <div class="status success">
                            âœ… ë°ì´í„°ê°€ ìœ ì§€ë¨ (ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ë™ì¼)
                        </div>
                    `;
                    loadAndCheck();
                } else {
                    status.innerHTML = `
                        <div class="status error">
                            âŒ ë°ì´í„° ë³€ê²½ë¨!
                            <br>ì´ì „: ${beforeRefresh ? beforeRefresh.length + ' bytes' : 'ì—†ìŒ'}
                            <br>ì´í›„: ${afterRefresh ? afterRefresh.length + ' bytes' : 'ì—†ìŒ'}
                        </div>
                    `;
                }
            }, 100);
        }

        // ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
        function monitorStorage() {
            if (monitorInterval) {
                clearInterval(monitorInterval);
            }

            const monitor = document.getElementById('storageMonitor');
            const status = document.getElementById('monitorStatus');

            status.innerHTML = '<div class="status info">ğŸ”´ ëª¨ë‹ˆí„°ë§ ì¤‘...</div>';

            monitorInterval = setInterval(() => {
                const data = localStorage.getItem('conceptArtData');
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        monitor.innerHTML = `
                            <strong>í˜„ì¬ ì‹œê°„:</strong> ${new Date().toLocaleTimeString()}
                            <br><strong>ë°ì´í„° í¬ê¸°:</strong> ${data.length} bytes
                            <br><strong>Universal:</strong> ${parsed.universal ? 'âœ… ìˆìŒ' : 'âŒ ì—†ìŒ'}
                            <br><strong>Translated:</strong> ${parsed.universal_translated ? 'âœ… ìˆìŒ' : 'âŒ ì—†ìŒ'}
                            <br><strong>ìµœì¢… ì €ì¥:</strong> ${parsed.lastSaved || 'ì•Œ ìˆ˜ ì—†ìŒ'}
                        `;
                    } catch (e) {
                        monitor.innerHTML = `íŒŒì‹± ì˜¤ë¥˜: ${e.message}`;
                    }
                } else {
                    monitor.innerHTML = 'ë°ì´í„° ì—†ìŒ';
                }
            }, 1000);
        }

        function stopMonitoring() {
            if (monitorInterval) {
                clearInterval(monitorInterval);
                monitorInterval = null;
                document.getElementById('monitorStatus').innerHTML =
                    '<div class="status info">âš« ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ë¨</div>';
            }
        }

        // ìƒíƒœ ìº¡ì²˜
        function captureBeforeState() {
            beforeState = localStorage.getItem('conceptArtData');
            document.getElementById('compareResult').innerHTML =
                `<div class="status info">ğŸ“¸ í˜„ì¬ ìƒíƒœ ìº¡ì²˜ë¨ (${beforeState ? beforeState.length + ' bytes' : 'ë°ì´í„° ì—†ìŒ'})</div>`;
        }

        // ìƒíƒœ ë¹„êµ
        function compareStates() {
            const currentState = localStorage.getItem('conceptArtData');
            const result = document.getElementById('compareResult');

            if (!beforeState) {
                result.innerHTML = '<div class="status warning">âš ï¸ ë¹„êµí•  ì´ì „ ìƒíƒœê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            if (beforeState === currentState) {
                result.innerHTML = '<div class="status success">âœ… ë°ì´í„° ë³€ê²½ ì—†ìŒ</div>';
            } else {
                let beforeData = null, currentData = null;
                try {
                    beforeData = beforeState ? JSON.parse(beforeState) : {};
                    currentData = currentState ? JSON.parse(currentState) : {};

                    const changes = [];
                    if (beforeData.universal !== currentData.universal) {
                        changes.push(`Universal: ${beforeData.universal ? 'ìˆìŒ' : 'ì—†ìŒ'} â†’ ${currentData.universal ? 'ìˆìŒ' : 'ì—†ìŒ'}`);
                    }
                    if (beforeData.universal_translated !== currentData.universal_translated) {
                        changes.push(`Translated: ${beforeData.universal_translated ? 'ìˆìŒ' : 'ì—†ìŒ'} â†’ ${currentData.universal_translated ? 'ìˆìŒ' : 'ì—†ìŒ'}`);
                    }

                    result.innerHTML = `
                        <div class="status warning">
                            âš ï¸ ë°ì´í„° ë³€ê²½ ê°ì§€
                            <br>ë³€ê²½ì‚¬í•­:
                            <ul>${changes.map(c => `<li>${c}</li>`).join('')}</ul>
                        </div>
                    `;
                } catch (e) {
                    result.innerHTML = `<div class="status error">âŒ ë¹„êµ ì˜¤ë¥˜: ${e.message}</div>`;
                }
            }
        }

        // ë¬¸ì œ ì§„ë‹¨
        function diagnoseIssue() {
            const result = document.getElementById('diagnosisResult');
            const issues = [];
            const solutions = [];

            // localStorage í™•ì¸
            const data = localStorage.getItem('conceptArtData');
            if (!data) {
                issues.push('âŒ localStorageì— conceptArtDataê°€ ì—†ìŠµë‹ˆë‹¤');
                solutions.push('saveData() í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ê³  ìˆëŠ”ì§€ í™•ì¸');
            } else {
                try {
                    const parsed = JSON.parse(data);

                    // universal í”„ë¡¬í”„íŠ¸ í™•ì¸
                    if (!parsed.universal || parsed.universal === 'ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...') {
                        issues.push('âš ï¸ Universal í”„ë¡¬í”„íŠ¸ê°€ ë¹„ì–´ìˆê±°ë‚˜ ê¸°ë³¸ê°’ì…ë‹ˆë‹¤');
                        solutions.push('savePromptEditì—ì„œ conceptData.universalì´ ì œëŒ€ë¡œ ì„¤ì •ë˜ëŠ”ì§€ í™•ì¸');
                    }

                    // prompts ê°ì²´ í™•ì¸
                    if (!parsed.prompts || Object.keys(parsed.prompts).length === 0) {
                        issues.push('âš ï¸ prompts ê°ì²´ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
                        solutions.push('í˜„ì¬ ì„ íƒëœ ìºë¦­í„°/ì¥ì†Œ/ì†Œí’ˆì´ ìˆëŠ”ì§€ í™•ì¸');
                    }

                    // íƒ€ì„ìŠ¤íƒ¬í”„ í™•ì¸
                    if (!parsed.lastSaved && !parsed.lastUpdated) {
                        issues.push('â„¹ï¸ ì €ì¥ íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ì—†ìŠµë‹ˆë‹¤');
                        solutions.push('ë°ì´í„° ì €ì¥ ì‹œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€ ê¶Œì¥');
                    }

                } catch (e) {
                    issues.push(`âŒ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜: ${e.message}`);
                    solutions.push('localStorage ë°ì´í„°ê°€ ì†ìƒë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤');
                }
            }

            // sessionStorage í™•ì¸
            const sessionData = sessionStorage.getItem('conceptArtData');
            if (sessionData && sessionData !== data) {
                issues.push('âš ï¸ sessionStorageì™€ localStorage ë°ì´í„°ê°€ ë‹¤ë¦…ë‹ˆë‹¤');
                solutions.push('ë™ê¸°í™” ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤');
            }

            // ê²°ê³¼ í‘œì‹œ
            result.innerHTML = `
                <div class="status ${issues.length > 0 ? 'warning' : 'success'}">
                    <h3>ì§„ë‹¨ ê²°ê³¼:</h3>
                    ${issues.length > 0 ?
                        `<strong>ë°œê²¬ëœ ë¬¸ì œ:</strong><ul>${issues.map(i => `<li>${i}</li>`).join('')}</ul>` :
                        'âœ… ë¬¸ì œê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'}
                    ${solutions.length > 0 ?
                        `<strong>í•´ê²° ë°©ë²•:</strong><ul>${solutions.map(s => `<li>${s}</li>`).join('')}</ul>` : ''}
                </div>
            `;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° í™•ì¸
        window.addEventListener('DOMContentLoaded', () => {
            loadAndCheck();
        });

        // Storage ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.addEventListener('storage', (e) => {
            if (e.key === 'conceptArtData') {
                console.log('Storage ì´ë²¤íŠ¸ ê°ì§€:', {
                    key: e.key,
                    oldValue: e.oldValue ? 'ìˆìŒ' : 'ì—†ìŒ',
                    newValue: e.newValue ? 'ìˆìŒ' : 'ì—†ìŒ'
                });
            }
        });
    </script>
</body>
</html>