<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프롬프트 영구 저장 테스트</title>
    <style>
        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
        }
        button:hover {
            background: #5a6fd8;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        .info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }
        .warning {
            background: #fff3e0;
            color: #ef6c00;
            border-left: 4px solid #ff9800;
        }
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .prompt-display {
            background: white;
            border: 2px solid #667eea;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            min-height: 100px;
            white-space: pre-wrap;
        }
        .highlight {
            background: yellow;
            font-weight: bold;
            padding: 2px 4px;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 프롬프트 영구 저장 테스트</h1>

        <!-- 1. 프롬프트 직접 저장 테스트 -->
        <div class="test-section">
            <h2>1. 프롬프트 직접 저장 테스트</h2>
            <textarea id="testPrompt" placeholder="테스트할 프롬프트를 입력하세요...">STYLE: Photorealistic portrait, Steve McCurry style;
ARTIST: Steve McCurry;
MEDIUM: Photography;
GENRE: Heartwarming Comedy;
CHARACTER: Hajun, Korean male 28 chef;</textarea>
            <br>
            <button onclick="saveTestPrompt()">프롬프트 저장</button>
            <button onclick="loadAndCheck()">저장된 데이터 확인</button>
            <button onclick="simulateRefresh()">새로고침 시뮬레이션</button>
            <div id="saveStatus"></div>
        </div>

        <!-- 2. localStorage 실시간 모니터 -->
        <div class="test-section">
            <h2>2. localStorage 실시간 모니터</h2>
            <button onclick="monitorStorage()">실시간 모니터링 시작</button>
            <button onclick="stopMonitoring()">모니터링 중지</button>
            <div id="monitorStatus"></div>
            <div class="prompt-display" id="storageMonitor">대기중...</div>
        </div>

        <!-- 3. 데이터 비교 -->
        <div class="test-section">
            <h2>3. 저장 전후 비교</h2>
            <button onclick="captureBeforeState()">현재 상태 캡처</button>
            <button onclick="compareStates()">변경사항 비교</button>
            <div id="compareResult"></div>
        </div>

        <!-- 4. 문제 진단 -->
        <div class="test-section">
            <h2>4. 문제 진단</h2>
            <button onclick="diagnoseIssue()">문제 진단 실행</button>
            <div id="diagnosisResult"></div>
        </div>
    </div>

    <script>
        let monitorInterval = null;
        let beforeState = null;

        // 테스트 프롬프트 저장
        function saveTestPrompt() {
            const prompt = document.getElementById('testPrompt').value;
            const status = document.getElementById('saveStatus');

            // 기존 데이터 가져오기 또는 새로 생성
            let conceptData = {};
            const existing = localStorage.getItem('conceptArtData');
            if (existing) {
                try {
                    conceptData = JSON.parse(existing);
                } catch (e) {
                    console.error('기존 데이터 파싱 오류:', e);
                    conceptData = {};
                }
            }

            // 프롬프트 데이터 설정
            conceptData.universal = prompt;
            conceptData.universal_translated = '번역된 ' + prompt.substring(0, 50);
            conceptData.lastSaved = new Date().toISOString();

            // prompts 객체가 없으면 생성
            if (!conceptData.prompts) {
                conceptData.prompts = {};
            }

            // localStorage에 저장
            try {
                const dataString = JSON.stringify(conceptData);
                localStorage.setItem('conceptArtData', dataString);

                // 저장 확인
                const saved = localStorage.getItem('conceptArtData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed.universal === prompt) {
                        status.innerHTML = `
                            <div class="status success">
                                ✅ 저장 성공!
                                <br>저장 시간: ${new Date().toLocaleTimeString()}
                                <br>데이터 크기: ${dataString.length} bytes
                                <br>Universal 프롬프트: ${parsed.universal ? '있음' : '없음'}
                            </div>
                        `;
                    } else {
                        status.innerHTML = `
                            <div class="status warning">
                                ⚠️ 저장되었지만 데이터 불일치
                            </div>
                        `;
                    }
                } else {
                    status.innerHTML = `
                        <div class="status error">
                            ❌ localStorage에서 데이터를 찾을 수 없음
                        </div>
                    `;
                }
            } catch (e) {
                status.innerHTML = `
                    <div class="status error">
                        ❌ 저장 오류: ${e.message}
                    </div>
                `;
            }
        }

        // 저장된 데이터 확인
        function loadAndCheck() {
            const status = document.getElementById('saveStatus');
            const data = localStorage.getItem('conceptArtData');

            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    status.innerHTML = `
                        <div class="status info">
                            📦 저장된 데이터:
                            <pre>${JSON.stringify({
                                universal: parsed.universal ? parsed.universal.substring(0, 100) + '...' : '없음',
                                universal_translated: parsed.universal_translated ? '있음' : '없음',
                                lastSaved: parsed.lastSaved || '알 수 없음',
                                prompts: parsed.prompts ? Object.keys(parsed.prompts).length + '개' : '0개'
                            }, null, 2)}</pre>
                        </div>
                    `;
                } catch (e) {
                    status.innerHTML = `
                        <div class="status error">
                            ❌ 데이터 파싱 오류: ${e.message}
                        </div>
                    `;
                }
            } else {
                status.innerHTML = `
                    <div class="status warning">
                        ⚠️ 저장된 데이터 없음
                    </div>
                `;
            }
        }

        // 새로고침 시뮬레이션
        function simulateRefresh() {
            const status = document.getElementById('saveStatus');

            // 현재 데이터 저장
            const beforeRefresh = localStorage.getItem('conceptArtData');

            // 잠시 후 다시 확인
            setTimeout(() => {
                const afterRefresh = localStorage.getItem('conceptArtData');

                if (beforeRefresh === afterRefresh) {
                    status.innerHTML = `
                        <div class="status success">
                            ✅ 데이터가 유지됨 (새로고침 후에도 동일)
                        </div>
                    `;
                    loadAndCheck();
                } else {
                    status.innerHTML = `
                        <div class="status error">
                            ❌ 데이터 변경됨!
                            <br>이전: ${beforeRefresh ? beforeRefresh.length + ' bytes' : '없음'}
                            <br>이후: ${afterRefresh ? afterRefresh.length + ' bytes' : '없음'}
                        </div>
                    `;
                }
            }, 100);
        }

        // 실시간 모니터링
        function monitorStorage() {
            if (monitorInterval) {
                clearInterval(monitorInterval);
            }

            const monitor = document.getElementById('storageMonitor');
            const status = document.getElementById('monitorStatus');

            status.innerHTML = '<div class="status info">🔴 모니터링 중...</div>';

            monitorInterval = setInterval(() => {
                const data = localStorage.getItem('conceptArtData');
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        monitor.innerHTML = `
                            <strong>현재 시간:</strong> ${new Date().toLocaleTimeString()}
                            <br><strong>데이터 크기:</strong> ${data.length} bytes
                            <br><strong>Universal:</strong> ${parsed.universal ? '✅ 있음' : '❌ 없음'}
                            <br><strong>Translated:</strong> ${parsed.universal_translated ? '✅ 있음' : '❌ 없음'}
                            <br><strong>최종 저장:</strong> ${parsed.lastSaved || '알 수 없음'}
                        `;
                    } catch (e) {
                        monitor.innerHTML = `파싱 오류: ${e.message}`;
                    }
                } else {
                    monitor.innerHTML = '데이터 없음';
                }
            }, 1000);
        }

        function stopMonitoring() {
            if (monitorInterval) {
                clearInterval(monitorInterval);
                monitorInterval = null;
                document.getElementById('monitorStatus').innerHTML =
                    '<div class="status info">⚫ 모니터링 중지됨</div>';
            }
        }

        // 상태 캡처
        function captureBeforeState() {
            beforeState = localStorage.getItem('conceptArtData');
            document.getElementById('compareResult').innerHTML =
                `<div class="status info">📸 현재 상태 캡처됨 (${beforeState ? beforeState.length + ' bytes' : '데이터 없음'})</div>`;
        }

        // 상태 비교
        function compareStates() {
            const currentState = localStorage.getItem('conceptArtData');
            const result = document.getElementById('compareResult');

            if (!beforeState) {
                result.innerHTML = '<div class="status warning">⚠️ 비교할 이전 상태가 없습니다</div>';
                return;
            }

            if (beforeState === currentState) {
                result.innerHTML = '<div class="status success">✅ 데이터 변경 없음</div>';
            } else {
                let beforeData = null, currentData = null;
                try {
                    beforeData = beforeState ? JSON.parse(beforeState) : {};
                    currentData = currentState ? JSON.parse(currentState) : {};

                    const changes = [];
                    if (beforeData.universal !== currentData.universal) {
                        changes.push(`Universal: ${beforeData.universal ? '있음' : '없음'} → ${currentData.universal ? '있음' : '없음'}`);
                    }
                    if (beforeData.universal_translated !== currentData.universal_translated) {
                        changes.push(`Translated: ${beforeData.universal_translated ? '있음' : '없음'} → ${currentData.universal_translated ? '있음' : '없음'}`);
                    }

                    result.innerHTML = `
                        <div class="status warning">
                            ⚠️ 데이터 변경 감지
                            <br>변경사항:
                            <ul>${changes.map(c => `<li>${c}</li>`).join('')}</ul>
                        </div>
                    `;
                } catch (e) {
                    result.innerHTML = `<div class="status error">❌ 비교 오류: ${e.message}</div>`;
                }
            }
        }

        // 문제 진단
        function diagnoseIssue() {
            const result = document.getElementById('diagnosisResult');
            const issues = [];
            const solutions = [];

            // localStorage 확인
            const data = localStorage.getItem('conceptArtData');
            if (!data) {
                issues.push('❌ localStorage에 conceptArtData가 없습니다');
                solutions.push('saveData() 함수가 호출되고 있는지 확인');
            } else {
                try {
                    const parsed = JSON.parse(data);

                    // universal 프롬프트 확인
                    if (!parsed.universal || parsed.universal === '기본 프롬프트가 여기에 표시됩니다...') {
                        issues.push('⚠️ Universal 프롬프트가 비어있거나 기본값입니다');
                        solutions.push('savePromptEdit에서 conceptData.universal이 제대로 설정되는지 확인');
                    }

                    // prompts 객체 확인
                    if (!parsed.prompts || Object.keys(parsed.prompts).length === 0) {
                        issues.push('⚠️ prompts 객체가 비어있습니다');
                        solutions.push('현재 선택된 캐릭터/장소/소품이 있는지 확인');
                    }

                    // 타임스탬프 확인
                    if (!parsed.lastSaved && !parsed.lastUpdated) {
                        issues.push('ℹ️ 저장 타임스탬프가 없습니다');
                        solutions.push('데이터 저장 시 타임스탬프 추가 권장');
                    }

                } catch (e) {
                    issues.push(`❌ 데이터 파싱 오류: ${e.message}`);
                    solutions.push('localStorage 데이터가 손상되었을 수 있습니다');
                }
            }

            // sessionStorage 확인
            const sessionData = sessionStorage.getItem('conceptArtData');
            if (sessionData && sessionData !== data) {
                issues.push('⚠️ sessionStorage와 localStorage 데이터가 다릅니다');
                solutions.push('동기화 문제일 수 있습니다');
            }

            // 결과 표시
            result.innerHTML = `
                <div class="status ${issues.length > 0 ? 'warning' : 'success'}">
                    <h3>진단 결과:</h3>
                    ${issues.length > 0 ?
                        `<strong>발견된 문제:</strong><ul>${issues.map(i => `<li>${i}</li>`).join('')}</ul>` :
                        '✅ 문제가 발견되지 않았습니다'}
                    ${solutions.length > 0 ?
                        `<strong>해결 방법:</strong><ul>${solutions.map(s => `<li>${s}</li>`).join('')}</ul>` : ''}
                </div>
            `;
        }

        // 페이지 로드 시 초기 확인
        window.addEventListener('DOMContentLoaded', () => {
            loadAndCheck();
        });

        // Storage 이벤트 리스너
        window.addEventListener('storage', (e) => {
            if (e.key === 'conceptArtData') {
                console.log('Storage 이벤트 감지:', {
                    key: e.key,
                    oldValue: e.oldValue ? '있음' : '없음',
                    newValue: e.newValue ? '있음' : '없음'
                });
            }
        });
    </script>
</body>
</html>